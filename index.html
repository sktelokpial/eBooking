<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Tempahan Makmal Komputer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .calendar-day {
            transition: all 0.2s ease-in-out;
        }
        .calendar-day:not(.disabled):hover {
            transform: scale(1.05);
            background-color: #e0f2fe;
        }
        .calendar-day.selected {
            background-color: #0284c7;
            color: white;
            font-weight: bold;
        }
        .calendar-day.booked {
            background-color: #fecaca;
            color: #991b1b;
            cursor: not-allowed;
            position: relative;
        }
        .calendar-day.booked::after {
            content: 'Penuh';
            position: absolute;
            bottom: 2px;
            right: 4px;
            font-size: 0.65rem;
            font-weight: 500;
        }
        select option:disabled {
            color: #9ca3af;
            background-color: #f3f4f6;
        }
        button:disabled {
            cursor: not-allowed;
            background-color: #9ca3af;
            opacity: 0.7;
        }
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .timetable-cell {
            min-height: 100px;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <!-- UBAH SUAI: GANTIKAN 'src' DENGAN PAUTAN LOGO SEKOLAH ANDA -->
            <img src="https://i.postimg.cc/SK80jB5p/unnamed.png" alt="Logo Sekolah" class="mx-auto h-24 w-auto mb-4 rounded-full">
            
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Sistem Tempahan Makmal Komputer</h1>
            <p class="mt-2 text-md text-gray-600">Sila pilih tarikh, isi borang, dan rujuk jadual di bawah.</p>
        </header>

        <div class="max-w-4xl mx-auto">
            <!-- Bahagian Kalendar dan Borang -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-2 text-gray-800">Borang Tempahan</h2>
                <div id="booking-info" class="text-sm text-yellow-800 bg-yellow-50 p-3 rounded-lg mb-4">
                    <!-- Mesej mengenai tetingkap tempahan -->
                </div>
                <!-- Paparan Kalendar -->
                <div id="calendar" class="mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <button id="prev-month" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">&lt; Bulan Lepas</button>
                        <h3 id="month-year" class="text-xl font-semibold"></h3>
                        <button id="next-month" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg">Bulan Depan &gt;</button>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2 text-center"></div>
                </div>
                <!-- Borang Tempahan -->
                <form id="booking-form" class="space-y-4">
                    <!-- Medan Borang di sini -->
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nama Guru</label>
                        <select id="name" name="name" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-100">
                            <option value="">-- Pilih Guru --</option>
                            <option value="EN MASRI BIN MAT SOM">EN MASRI BIN MAT SOM</option>
                            <option value="EN MOHD SHUKRI BIN ABDULLAH">EN MOHD SHUKRI BIN ABDULLAH</option>
                            <option value="PN MIMI HAFIZAH BINTI ADNAN">PN MIMI HAFIZAH BINTI ADNAN</option>
                            <option value="EN MOHD ZAMRI BIN JAMALUDIN">EN MOHD ZAMRI BIN JAMALUDIN</option>
                            <option value="PN WAN MURNI WATI BINTI MAT RANI">PN WAN MURNI WATI BINTI MAT RANI</option>
                            <option value="EN MOHD SUHAIMI BIN OTHMAN">EN MOHD SUHAIMI BIN OTHMAN</option>
                            <option value="PN NOR'AZIAH BT MOHD STAR">PN NOR'AZIAH BT MOHD STAR</option>
                            <option value="PN RABEAH BT JAHAYA">PN RABEAH BT JAHAYA</option>
                            <option value="PN NOR FADILAH BT SAAT">PN NOR FADILAH BT SAAT</option>
                            <option value="PN NOR AZA BT YAHYA">PN NOR AZA BT YAHYA</option>
                            <option value="PN AZIZAH BT MOKHTAR">PN AZIZAH BT MOKHTAR</option>
                            <option value="EN MUHAMMAD HILMAN BIN ABD HALIM">EN MUHAMMAD HILMAN BIN ABD HALIM</option>
                            <option value="PN NURUL ADIBAH BT MOHD SIBI">PN NURUL ADIBAH BT MOHD SIBI</option>
                            <option value="PN SHUZANNA BINTI SHOIB">PN SHUZANNA BINTI SHOIB</option>
                            <option value="EN ABD NASIR BIN SHAARANI">EN ABD NASIR BIN SHAARANI</option>
                            <option value="PN NOR AFIFAH BT MAT SALIM">PN NOR AFIFAH BT MAT SALIM</option>
                            <option value="PN NIK NORLINI BINTI NIK DIN">PN NIK NORLINI BINTI NIK DIN</option>
                            <option value="PN JAMILah BT MOKHTAR">PN JAMILAH BT MOKHTAR</option>
                            <option value="PN SUHAILY BT MAT NOR">PN SUHAILY BT MAT NOR</option>
                            <option value="PN NURUL IZZATI BT HASMI">PN NURUL IZZATI BT HASMI</option>
                        </select>
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700">Kelas</label>
                        <select id="department" name="department" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-100">
                            <option value="">-- Pilih Kelas --</option>
                            <option value="PRASEKOLAH PINTAR">PRASEKOLAH PINTAR</option>
                            <option value="TAHUN 1 CERDAS">TAHUN 1 CERDAS</option>
                            <option value="TAHUN 2 CERDIK">TAHUN 2 CERDIK</option>
                            <option value="TAHUN 3 BIJAK">TAHUN 3 BIJAK</option>
                            <option value="TAHUN 4 PINTAR">TAHUN 4 PINTAR</option>
                            <option value="TAHUN 5 MUMTAZ">TAHUN 5 MUMTAZ</option>
                            <option value="TAHUN 6 GENIUS">TAHUN 6 GENIUS</option>
                            <option value="LAIN-LAIN">LAIN-LAIN</option>
                        </select>
                    </div>
                    <div>
                        <label for="subject" class="block text-sm font-medium text-gray-700">Subjek</label>
                        <select id="subject" name="subject" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-100">
                            <option value="">-- Pilih Subjek --</option>
                            <option value="BM">BM</option>
                            <option value="BI">BI</option>
                            <option value="MATE">MATE</option>
                            <option value="SAINS">SAINS</option>
                            <option value="BA">BA</option>
                            <option value="PJ">PJ</option>
                            <option value="PK">PK</option>
                            <option value="PS">PS</option>
                            <option value="MZ">MZ</option>
                            <option value="PI">PI</option>
                            <option value="ULM">ULM</option>
                            <option value="TSMK">TSMK</option>
                            <option value="SJ">SJ</option>
                            <option value="RBT">RBT</option>
                            <option value="LAIN-LAIN">LAIN-LAIN</option>
                        </select>
                    </div>
                    <div>
                        <label for="booking-date" class="block text-sm font-medium text-gray-700">Tarikh Dipilih</p>
                        <input type="text" id="booking-date" name="booking-date" readonly class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="Sila pilih tarikh dari kalendar">
                    </div>
                    <div>
                        <label for="time-slot" class="block text-sm font-medium text-gray-700">Sesi Masa</label>
                        <select id="time-slot" name="time-slot" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm disabled:bg-gray-100">
                            <option value="">-- Sila Pilih Sesi --</option>
                            <option value="07:30AM">07:30 AM</option>
                            <option value="08:00AM">08:00 AM</option>
                            <option value="08:30AM">08:30 AM</option>
                            <option value="09:00AM">09:00 AM</option>
                            <option value="09:30AM">09:30 AM</option>
                            <option value="10:00AM">10:00 AM</option>
                            <option value="10:20AM">10:20 AM</option>
                            <option value="10:50AM">10:50 AM</option>
                            <option value="11:20AM">11:20 AM</option>
                            <option value="11:50AM">11:50 AM</option>
                            <option value="12:20PM">12:20 PM</option>
                            <option value="12:50PM">12:50 PM</option>
                        </select>
                    </div>
                    <button id="submit-button" type="submit" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 flex items-center justify-center">
                        <span id="submit-button-text">Hantar Tempahan</span>
                    </button>
                </form>
            </div>

            <!-- Bahagian Jadual Waktu -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-8">
                <header class="text-center mb-8">
                     <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Jadual Waktu Penggunaan</h1>
                </header>
                <!-- Navigasi Minggu -->
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-week" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm md:text-base">&lt; Minggu Lepas</button>
                    <h2 id="week-display" class="text-lg md:text-xl font-semibold text-center"></h2>
                    <button id="next-week" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm md:text-base">Minggu Depan &gt;</button>
                </div>
                <!-- Paparan Jadual -->
                <div class="overflow-x-auto">
                    <table id="timetable" class="min-w-full border-collapse border border-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="border border-gray-300 p-2 w-24">Masa</th>
                            </tr>
                        </thead>
                        <tbody id="timetable-body"></tbody>
                    </table>
                </div>
                <div id="loading-spinner" class="text-center p-8">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-sky-600"></div>
                    <p class="mt-2">Memuatkan data jadual...</p>
                </div>
            </div>
        </div>
        
        <div id="notification" class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transition-opacity duration-300"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- PENTING: GANTIKAN DENGAN URL APPS SCRIPT ANDA ---
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzrkJ5yV-XVMShatptZGt3SiR7tMn7xhBlrkZHQlyw_3neMLdyfJlZ4jD342x5nzu_VFA/exec';

            // State Aplikasi
            let allBookings = [];
            let currentDate = new Date();
            let selectedDate = null;
            let currentWeekStart = new Date();

            // Elemen DOM Borang
            const calendarGrid = document.getElementById('calendar-grid');
            const monthYearEl = document.getElementById('month-year');
            const prevMonthBtn = document.getElementById('prev-month');
            const nextMonthBtn = document.getElementById('next-month');
            const bookingForm = document.getElementById('booking-form');
            const selectedDateEl = document.getElementById('booking-date');
            const timeSlotSelect = document.getElementById('time-slot');
            const notificationEl = document.getElementById('notification');
            const submitButton = document.getElementById('submit-button');
            const bookingInfoEl = document.getElementById('booking-info');
            const submitButtonText = document.getElementById('submit-button-text');

            // Elemen DOM Jadual
            const timetableBody = document.getElementById('timetable-body');
            const weekDisplay = document.getElementById('week-display');
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const loadingSpinner = document.getElementById('loading-spinner');
            const timetable = document.getElementById('timetable');

            // Tetapkan hari pertama minggu kepada Isnin untuk jadual
            const todayForTimetable = new Date();
            const dayOfWeek = todayForTimetable.getDay();
            const diff = todayForTimetable.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
            currentWeekStart = new Date(todayForTimetable.setDate(diff));
            currentWeekStart.setHours(0, 0, 0, 0);
            
            const timeSlots = ["07:30AM", "08:00AM", "08:30AM", "09:00AM", "09:30AM", "10:00AM", "10:20AM", "10:50AM", "11:20AM", "11:50AM", "12:20PM", "12:50PM"];
            const daysOfWeek = ['Isnin', 'Selasa', 'Rabu', 'Khamis', 'Jumaat']; // UBAH SUAI: Hanya Isnin-Jumaat

            // --- FUNGSI-FUNGSI UTAMA ---

            async function fetchAndInitialize() {
                timetable.style.display = 'none';
                loadingSpinner.style.display = 'block';
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=read`);
                    const result = await response.json();
                    if (result.success) {
                        allBookings = result.data.map(item => ({
                            id: item['ID Tempahan'],
                            name: item['Nama Guru'],
                            department: item['Kelas'],
                            date: item['Tarikh Tempahan'],
                            timeSlot: item['Slot Masa'],
                            subject: item['Subjek']
                        }));
                        // Jana kedua-dua kalendar dan jadual selepas data berjaya dimuatkan
                        generateCalendar(currentDate);
                        generateTimetable();
                    } else {
                       throw new Error('Gagal mendapatkan data.');
                    }
                } catch (error) {
                    loadingSpinner.innerHTML = `<p class="text-red-500">Gagal memuatkan data. Sila pastikan URL Apps Script betul dan cuba lagi.</p>`;
                    toggleForm(false, 'Gagal Memuatkan Data');
                }
            }
            
            // Fungsi untuk Kalendar Tempahan
            function generateCalendar(date) {
                 calendarGrid.innerHTML = '';
                const month = date.getMonth();
                const year = date.getFullYear();
                
                monthYearEl.textContent = `${date.toLocaleString('ms-MY', { month: 'long' })} ${year}`;
                
                const now = new Date();
                const dateFormatter = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Kuala_Lumpur', year: 'numeric', month: '2-digit', day: '2-digit'});
                const todayStringKL = dateFormatter.format(now);
                const today = new Date(todayStringKL + 'T00:00:00');
                const todayDay = today.getDay(); 

                const isBookingWindowOpen = todayDay === 6 || todayDay === 0;
                
                let startOfBookingPeriod, endOfBookingPeriod;
                if(isBookingWindowOpen) {
                    startOfBookingPeriod = new Date(today);
                    const daysUntilNextMonday = (1 - todayDay + 7) % 7 || 7;
                    startOfBookingPeriod.setDate(today.getDate() + daysUntilNextMonday);
                    
                    endOfBookingPeriod = new Date(startOfBookingPeriod);
                    endOfBookingPeriod.setDate(startOfBookingPeriod.getDate() + 6);
                    
                    bookingInfoEl.textContent = `Tempahan kini dibuka untuk minggu ${startOfBookingPeriod.toLocaleDateString('ms-MY')} hingga ${endOfBookingPeriod.toLocaleDateString('ms-MY')}.`;
                    toggleForm(true);
                } else {
                    bookingInfoEl.textContent = 'Tempahan untuk minggu hadapan hanya dibuka pada hari Sabtu dan Ahad.';
                    toggleForm(false, 'Tempahan Ditutup');
                }

                const calendarDaysOfWeek = ['Isn', 'Sel', 'Rab', 'Kha', 'Jum', 'Sab', 'Aha'];
                calendarGrid.innerHTML = ''; // Kosongkan grid sebelum jana
                calendarDaysOfWeek.forEach(day => {
                    const dayEl = document.createElement('div');
                    dayEl.className = 'font-semibold text-sm text-gray-600';
                    dayEl.textContent = day;
                    calendarGrid.appendChild(dayEl);
                });

                const firstDayOfMonth = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const emptyCells = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1;

                for (let i = 0; i < emptyCells; i++) calendarGrid.appendChild(document.createElement('div'));

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayEl = document.createElement('div');
                    const dayDate = new Date(year, month, day);
                    const dateString = dayDate.toISOString().split('T')[0];
                    
                    dayEl.textContent = day;
                    dayEl.className = 'p-2 rounded-full cursor-pointer calendar-day';
                    dayEl.dataset.date = dateString;
                    
                    let isSelectable = !(dayDate < today || (isBookingWindowOpen ? (dayDate < startOfBookingPeriod || dayDate > endOfBookingPeriod) : true));

                    if (!isSelectable) {
                         dayEl.classList.add('disabled', 'text-gray-400', 'cursor-not-allowed', 'bg-gray-100');
                    } else {
                        const bookingsOnDate = allBookings.filter(b => b.date === dateString);
                        if (bookingsOnDate.length >= timeSlots.length) dayEl.classList.add('booked');

                        dayEl.addEventListener('click', () => {
                             if (dayEl.classList.contains('booked')) return showNotification('Tarikh ini telah ditempah sepenuhnya.', true);
                            
                            document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
                            dayEl.classList.add('selected');
                            selectedDate = dateString;
                            selectedDateEl.value = dayDate.toLocaleString('ms-MY', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
                            updateAvailableTimeSlots(selectedDate);
                        });
                    }
                    calendarGrid.appendChild(dayEl);
                }
            }

            // Fungsi untuk Jadual Waktu
            function generateTimetable() {
                timetable.style.display = 'table';
                loadingSpinner.style.display = 'none';
                
                const thead = timetable.querySelector('thead tr');
                thead.innerHTML = '<th class="border border-gray-300 p-2 w-24">Masa</th>';
                
                const weekDates = [];
                // UBAH SUAI: Loop hanya 5 kali untuk Isnin-Jumaat
                for(let i=0; i<5; i++) { 
                    const date = new Date(currentWeekStart);
                    date.setDate(currentWeekStart.getDate() + i);
                    weekDates.push(date);
                    const th = document.createElement('th');
                    th.className = "border border-gray-300 p-2 text-sm md:text-base";
                    th.innerHTML = `${daysOfWeek[i]}<br><span class="font-normal text-xs">${date.toLocaleDateString('ms-MY', {day: '2-digit', month: '2-digit'})}</span>`;
                    thead.appendChild(th);
                }

                const start = weekDates[0].toLocaleDateString('ms-MY');
                // UBAH SUAI: Tarikh akhir kini adalah Jumaat (indeks 4)
                const end = weekDates[4].toLocaleDateString('ms-MY'); 
                weekDisplay.textContent = `${start} - ${end}`;
                
                timetableBody.innerHTML = '';
                timeSlots.forEach(slot => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td class="border border-gray-300 p-2 font-semibold text-center text-sm">${slot.replace('AM',' PG').replace('PM', ' PTG')}</td>`;
                    // Loop ini akan secara automatik menjadi 5 kerana `weekDates` kini mempunyai 5 elemen
                    weekDates.forEach(date => { 
                        const dateString = date.toISOString().split('T')[0];
                        const booking = allBookings.find(b => b.date === dateString && b.timeSlot === slot);
                        const td = document.createElement('td');
                        td.className = 'border border-gray-300 p-2 align-top timetable-cell text-xs';
                        if (booking) {
                            td.classList.add('bg-sky-100');
                            td.innerHTML = `<div class="font-semibold text-sky-800">${booking.name}</div><div class="text-gray-600">${booking.department}</div><div class="text-gray-600 font-medium">Sub: ${booking.subject}</div>`;
                        }
                        tr.appendChild(td);
                    });
                    timetableBody.appendChild(tr);
                });
            }

            // Fungsi-fungsi Bantuan (showNotification, toggleForm, dll.)
            function showNotification(message, isError = false) {
                 notificationEl.textContent = message;
                 notificationEl.className = `fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-xl transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                 setTimeout(() => notificationEl.classList.add('opacity-0'), 3000);
            }

            function toggleForm(enable, reason = '') {
                 const isFormDisabled = !enable;
                 Array.from(bookingForm.elements).forEach(el => el.tagName !== 'BUTTON' && (el.disabled = isFormDisabled));
                 submitButton.disabled = isFormDisabled;
                 submitButtonText.textContent = enable ? 'Hantar Tempahan' : reason;
            }

            function updateAvailableTimeSlots(dateString) {
                const bookedSlotsOnDate = allBookings.filter(b => b.date === dateString).map(b => b.timeSlot);
                Array.from(timeSlotSelect.options).forEach(option => {
                    if (option.value) {
                        const originalText = option.text.split(' - ')[0];
                        const isBooked = bookedSlotsOnDate.includes(option.value);
                        option.disabled = isBooked;
                        option.textContent = isBooked ? `${originalText} - (Ditempah)` : originalText;
                    }
                });
                timeSlotSelect.selectedIndex = 0;
            }
            
            // --- EVENT LISTENERS ---

            // Navigasi Kalendar
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate); });

            // Navigasi Jadual
            prevWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() - 7); generateTimetable(); });
            nextWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate() + 7); generateTimetable(); });

            // Penghantaran Borang
            bookingForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!selectedDate) return showNotification('Sila pilih tarikh pada kalendar dahulu.', true);
                
                const formData = new FormData(bookingForm);
                const newBooking = {
                    id: 'ID' + Date.now(),
                    date: selectedDate,
                    name: formData.get('name'),
                    department: formData.get('department'),
                    subject: formData.get('subject'),
                    timeSlot: formData.get('time-slot'),
                };
                
                if (!newBooking.name || !newBooking.department || !newBooking.subject || !newBooking.timeSlot) return showNotification('Sila lengkapkan semua medan.', true);
                if (allBookings.some(b => b.date === selectedDate && b.timeSlot === newBooking.timeSlot)) return showNotification('Maaf, slot masa ini telah ditempah.', true);

                submitButton.disabled = true;
                submitButtonText.innerHTML = '<span class="spinner"></span>Menyimpan...';

                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', body: JSON.stringify(newBooking) });
                    const result = await response.json();
                    if (!result.success) throw new Error(result.message || 'Ralat tidak diketahui.');
                    
                    allBookings.push(newBooking);
                    bookingForm.reset();
                    selectedDateEl.value = '';
                    selectedDate = null;
                    showNotification('Tempahan berjaya disimpan!');
                    generateCalendar(currentDate); // Kemas kini kalendar
                    generateTimetable(); // Kemas kini jadual
                } catch (error) {
                    showNotification(`Gagal menyimpan tempahan: ${error.message}`, true);
                } finally {
                    submitButton.disabled = false;
                    submitButtonText.innerHTML = 'Hantar Tempahan';
                }
            });

            // --- PERMULAAN APLIKASI ---
            if (SCRIPT_URL.includes('URL_APPS_SCRIPT')) {
                loadingSpinner.innerHTML = `<p class="text-red-500">Sila masukkan URL Apps Script yang sah di dalam kod.</p>`;
                toggleForm(false, 'Sila Konfigurasi URL');
            } else {
                fetchAndInitialize();
            }
        });
    </script>
</body>
</html>

